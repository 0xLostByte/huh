<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Final Mission â¤ï¸</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');

        /* --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© --- */
        body {
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: #333; font-family: 'Cairo', sans-serif;
            width: 100vw; height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; overflow: hidden;
            user-select: none; touch-action: manipulation; transition: all 0.8s ease;
        }

        /* Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„ØµÙˆØª) */
        #startBtn {
            position: fixed; z-index: 20000;
            padding: 15px 40px; font-size: 1.5rem;
            background: #ff6b81; color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: pulseBtn 2s infinite;
        }

        /* --- Ø·Ø¨Ù‚Ø§Øª Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª --- */
        #blackOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 9998; display: none; pointer-events: none; }
        #whiteFlash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10005; display: none; opacity: 1; transition: opacity 2s; pointer-events: none; }
        #scenarioText { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 2rem; font-weight: bold; display: none; z-index: 10000; text-shadow: 0 0 20px rgba(0,0,0,1); text-align: center; width: 100%; pointer-events: none; }

        /* --- Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª --- */
        #bgVideo, #burnBgVideo, #lyricsVideo {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -5; display: none;
        }
        #bgVideo { filter: brightness(0.6); }
        #burnBgVideo { filter: blur(8px) brightness(0.6); transition: filter 3s ease; }
        #lyricsVideo { z-index: -4; opacity: 0.8; mix-blend-mode: screen; }

        /* --- Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Games Container) --- */
        .game-container {
            width: 90%; max-width: 400px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 25px; padding: 25px; text-align: center;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            display: none; position: relative; transition: all 0.5s ease;
            z-index: 10; /* ØªØ£ÙƒØ¯Ù†Ø§ Ø£Ù†Ù‡Ø§ ÙÙˆÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        }

        .active-game { display: block; animation: fadeIn 0.6s ease; }

        /* --- Dark & Burn Modes --- */
        body.dark-mode { background: #000; }
        .game-container.dark-mode { background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.2); color: white; }
        .game-container.dark-mode h2 { color: #fff; }
        .game-container.burn-mode { background: rgba(20, 0, 0, 0.6); border: 2px solid #ff4500; color: #ffaeae; }
        .game-container.burn-mode h2 { color: #ff4500; }

        /* --- Memory Game --- */
        .memory-grid { display: grid; gap: 10px; margin: auto; justify-content: center; }
        .card { background: rgba(255, 255, 255, 0.9); height: 85px; border-radius: 15px; position: relative; transform-style: preserve-3d; transition: 0.5s; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .card.flipped { transform: rotateY(180deg); }
        .card img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 10px; backface-visibility: hidden; transform: rotateY(180deg); }
        .card .back { background: #89CFF0; width: 100%; height: 100%; border-radius: 12px; position: absolute; backface-visibility: hidden; top:0; left:0; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white; }

        /* --- XO --- */
        .xo-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 20px auto; width: 260px; }
        .cell { background: rgba(255,255,255,0.8); height: 80px; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 900; border-radius: 15px; cursor: pointer; }
        .cell.x { color: #ff6b81; } .cell.o { color: #48cfad; }

        /* --- Color Game --- */
        .simon-board { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 240px; margin: 20px auto; }
        .color-btn { height: 100px; border-radius: 20px; cursor: pointer; border: 4px solid white; opacity: 0.6; transition: 0.2s; }
        .color-btn.active { opacity: 1; transform: scale(1.05); }
        #green { background: #48cfad; } #red { background: #ff6b81; } #yellow { background: #ffce54; } #blue { background: #5d9cec; }

        /* --- Mario --- */
        #fullMarioGame { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; z-index: 5000; display: none; background: #000; }
        #marioFrame { width: 100%; height: 100%; border: none; }
        #finishMarioBtn { 
            position: fixed; top: 20px; left: 20px; 
            background: linear-gradient(45deg, #ff0055, #ff4444); 
            color: white; border: none; padding: 10px 25px; 
            border-radius: 50px; font-weight: bold; cursor: pointer; z-index: 5001; 
            border: 2px solid white; animation: pulseBtn 2s infinite; 
        }

        /* --- Marriage Video --- */
        #marryVideoLayer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 6000; display: none; background: #000; }
        #marryVideo { width: 100%; height: 100%; object-fit: contain; display: none; }
        #fingerHint { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; text-align: center; z-index: 6001; }
        .finger-circle { width: 140px; height: 140px; border: 8px solid #ff0055; border-radius: 50%; animation: pulseCircle 1.5s infinite; cursor: pointer; position: absolute; bottom: 80px; right: 40px; }
        .finger-circle::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255, 0, 85, 0.4); border-radius: 50%; transform: translate(-50%, -50%); transition: width 2s linear, height 2s linear; }
        .pressing .finger-circle::after { width: 100%; height: 100%; }

        /* --- Magic Heart --- */
        .magic-heart-stage { height: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .magic-heart { font-size: 6rem; cursor: pointer; transition: all 0.2s ease; animation: heartBeat 1.5s infinite; filter: drop-shadow(0 0 10px rgba(255, 0, 85, 0.5)); }
        .magic-heart.charging { animation: shake 0.1s infinite; }
        .final-gift-box { font-size: 8rem; cursor: pointer; display: none; animation: bounce 2s infinite; }
        .final-flower { font-size: 9rem; display: none; animation: popIn 1s forwards; }

        /* --- UI Elements --- */
        .status-text { margin-top: 15px; font-weight: bold; font-size: 1.2rem; padding: 5px 15px; border-radius: 20px; background: rgba(255,255,255,0.8); display: inline-block; }
        .toast-msg { position: fixed; top: 20px; right: 20px; background: white; color: #ff6b81; padding: 10px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: none; z-index: 2000; border: 2px solid #ff6b81; }
        .quiz-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .quiz-content { background: white; padding: 30px; border-radius: 20px; width: 80%; max-width: 350px; text-align: center; }
        .skip-btn { background: #ff6b81; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; display: none; position: absolute; bottom: 10px; right: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes pulseCircle { 0% { transform: scale(1); border-color: #ff0055; } 50% { transform: scale(1.1); border-color: #ff4444; } 100% { transform: scale(1); border-color: #ff0055; } }
        @keyframes heartBeat { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 25% { transform: translate(-1px, -2px) rotate(-1deg); } 50% { transform: translate(-3px, 0px) rotate(1deg); } 75% { transform: translate(3px, 2px) rotate(0deg); } 100% { transform: translate(1px, -1px) rotate(-1deg); } }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

    </style>
</head>
<body>

    <audio id="snapSound" src="https://res.cloudinary.com/dpvvxtuny/video/upload/v1766406788/FINGERSNAP_kr2iw3.mp3"></audio>
    <audio id="audio1" src="https://res.cloudinary.com/dpvvxtuny/video/upload/v1766406777/huh1_gx9yln.mp3"></audio>
    
    <video id="bgVideo" src="https://res.cloudinary.com/dpvvxtuny/video/upload/somke_it_qnr5ru.mp4" loop playsinline></video>
    <video id="lyricsVideo" src="https://res.cloudinary.com/dpvvxtuny/video/upload/itoff_hczlk5.mp4" loop playsinline muted></video>
    <video id="burnBgVideo" src="https://res.cloudinary.com/dpvvxtuny/video/upload/burn_mkp2b6.mp4" playsinline muted></video>

    <button id="startBtn" onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù‡Ù…Ø© â¤ï¸</button>

    <div id="blackOverlay"></div>
    <div id="whiteFlash"></div>
    <div id="scenarioText">ÙˆÙŠØª Ø§Ù„Ø´ÙƒÙ„ ÙƒØ°Ø§ Ø¨ÙŠØ¶...</div>
    <div id="toast" class="toast-msg">Ø´Ø·ÙˆØ±ØªÙŠÙŠÙŠ â¤ï¸</div>

    <div id="quizModal" class="quiz-modal">
        <div class="quiz-content">
            <h3>ØªØ¨ÙŠ ØªØ¹Ù…Ù„ÙŠ SKIPØŸ ğŸ‘€</h3>
            <p>Ø¬Ø§ÙˆØ¨ÙŠ: Ø§ÙŠØ´ Ø§ÙƒØ«Ø± Ø´ÙŠ Ø§Ø­Ø¨Ù‡ ÙÙŠ Ù‡Ù„ Ø¯Ù†ÙŠØ§ØŸ</p>
            <input type="text" id="quizAnswer" style="padding: 10px; width: 80%; margin: 15px 0; text-align: center;" placeholder="Ø§ÙƒØªØ¨ÙŠ Ù‡Ù†Ø§...">
            <br>
            <button onclick="checkAnswer()" style="background:#5d9cec; color:white; padding:10px 20px; border:none; border-radius:10px;">ØªØ£ÙƒÙŠØ¯</button>
            <button onclick="closeQuiz()" style="background:#ccc; color:black; padding:10px 20px; border:none; border-radius:10px;">Ø±Ø¬ÙˆØ¹</button>
            <p id="quizError" style="color:red; margin-top:10px;"></p>
        </div>
    </div>

    <div id="game1" class="game-container">
        <h2>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© ğŸ§ </h2>
        <p id="memLevelTitle">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„: ØªØ³Ø®ÙŠÙ† (4 Ø¨Ø·Ø§Ù‚Ø§Øª)</p>
        <div class="memory-grid" id="memoryGrid"></div>
    </div>

    <div id="game2" class="game-container">
        <h2>ØªØ­Ø¯ÙŠ XO âŒâ­•</h2>
        <p id="xoLevelText">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: 1 (Ø³Ù‡Ù„)</p>
        <p id="easeText" style="color:#ff6b81; display:none;"></p>
        <div class="xo-board" id="xoBoard"></div>
        <div class="status-text" id="xoStatus" style="color: #5d9cec;">Ø¯ÙˆØ±Ùƒ (Ø£Ù†Øª X)</div>
    </div>

    <div id="game3" class="game-container">
        <h2>ØªØ°ÙƒØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† ğŸ¨</h2>
        <p id="colorLevelText">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</p>
        <p id="hardModeText" style="color: red; font-weight: 900; font-size: 1.2rem; display: none;">ÙŠÙ„ ÙˆØ±ÙŠÙ†ÙŠ ÙƒÙŠÙ Ù…Ø¹ Ø§Ù„16 Ù‡Ø³Ø§ØŸ ğŸ”¥</p>
        <div class="simon-board">
            <div id="green" class="color-btn" onclick="handleColorClick('green')"></div>
            <div id="red" class="color-btn" onclick="handleColorClick('red')"></div>
            <div id="yellow" class="color-btn" onclick="handleColorClick('yellow')"></div>
            <div id="blue" class="color-btn" onclick="handleColorClick('blue')"></div>
        </div>
        <div class="status-text" id="colorStatus" style="color: #5d9cec;">Ø´ÙˆÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨..</div>
        <button id="skipBtn" class="skip-btn" onclick="showQuiz()">SKIP?</button>
    </div>

    <div id="fullMarioGame">
        <iframe id="marioFrame" src=""></iframe>
        <button id="finishMarioBtn" onclick="finishMario()">Ø®Ù„ØµØª Ù„Ø¹Ø¨! ğŸ˜</button>
    </div>

    <div id="marryVideoLayer">
        <div id="fingerHint">
            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;">Ø¶Ø¹ Ø¥ØµØ¨Ø¹Ùƒ Ù‡Ù†Ø§ Ù„Ù…Ø¯Ù‡ Ø«Ø§Ù†ÙŠØªÙŠÙ†</div>
            <div class="finger-circle" id="mainFingerBtn"></div>
        </div>
        <video id="marryVideo" src="https://res.cloudinary.com/dpvvxtuny/video/upload/marry_saos4r.mp4" playsinline muted></video>
    </div>

    <div id="game6" class="game-container">
        <h2>Ø§Ø¶ØºØ·ÙŠ â¤ï¸</h2>
        <p id="heartInstruction">Ø§Ø¶ØºØ·ÙŠ Ù…Ø·ÙˆÙ„Ø§Ù‹ Ø¹Ø´Ø§Ù† ÙŠÙ†ÙØ¬Ø± Ø§Ù„Ø­Ø¨...</p>
        <div class="magic-heart-stage">
            <div class="magic-heart" id="magicHeart">â¤ï¸</div>
            <div class="final-gift-box" id="finalGift" onclick="clickGift()">ğŸ</div>
            <div class="final-flower" id="finalFlower">ğŸŒ¹</div>
        </div>
    </div>

    <script>
        // --- Start & Setup ---
        function startGame() {
            document.getElementById('startBtn').style.display = 'none';
            const audio1 = document.getElementById('audio1');
            audio1.play().catch(e => console.log("Audio still blocked?"));
            
            // Show first game
            document.getElementById('game1').classList.add('active-game');
            initMemoryGame();
        }

        // --- Navigation ---
        function showToast(msg = "Ø´Ø·ÙˆØ±ØªÙŠÙŠÙŠ â¤ï¸") {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        function nextStage(c, n) {
            document.getElementById(c).classList.remove('active-game');
            
            if (c === 'game2' && n === 'game3') {
                triggerCinematicScenario();
            } else if (c === 'game3' && n === 'fullMarioGame') {
                startFullMario();
            } else {
                showToast("Ø´Ø·ÙˆØ±ØªÙŠÙŠÙŠ ğŸ˜");
                setTimeout(() => {
                    document.getElementById(n).classList.add('active-game');
                    if(n==='game2') initXO();
                    if(n==='game3') initColorGame();
                }, 500);
            }
        }

        // --- Cinematic (Scenario) ---
        function triggerCinematicScenario() {
            const audio1 = document.getElementById('audio1');
            const snap = document.getElementById('snapSound');
            const white = document.getElementById('whiteFlash');
            const black = document.getElementById('blackOverlay');
            const text = document.getElementById('scenarioText');
            const bgVideo = document.getElementById('bgVideo');
            const lyricsVideo = document.getElementById('lyricsVideo');

            audio1.pause();
            black.style.display = 'block';
            text.style.display = 'block';

            setTimeout(() => {
                text.style.display = 'none'; 
                setTimeout(() => {
                    snap.play();
                    black.style.display = 'none';
                    white.style.display = 'block';

                    document.body.classList.add('dark-mode');
                    document.querySelectorAll('.game-container').forEach(c => c.classList.add('dark-mode'));
                    
                    bgVideo.style.display = 'block';
                    bgVideo.muted = false; bgVideo.volume = 1.0; bgVideo.play();
                    
                    lyricsVideo.style.display = 'block';
                    lyricsVideo.play();

                    setTimeout(() => {
                        white.style.opacity = '0';
                        setTimeout(() => {
                            white.style.display = 'none';
                            document.getElementById('game3').classList.add('active-game');
                            initColorGame();
                        }, 2000);
                    }, 100);
                }, 5000); 
            }, 3000); 
        }

        // --- Memory Game ---
        const imgs = ['mem1.jpg', 'mem2.jpg', 'mem3.png', 'mem4.png', 'mem5.png', 'mem6.png']; // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±
        // Ø³Ù†Ø³ØªØ®Ø¯Ù… ØµÙˆØ± ØªØ¹Ø¨ÙŠØ±ÙŠØ© (Emojis) Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„ØµÙˆØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„ÙƒÙˆØ¯
        const emojis = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼'];
        
        let mLevel=1, flip=[], pairs=0, target=0;
        function initMemoryGame() {
            const grid=document.getElementById('memoryGrid'); grid.innerHTML=''; pairs=0; flip=[];
            let num = mLevel===1?2: mLevel===2?4:6;
            document.getElementById('memLevelTitle').innerText = mLevel===1?"Ù…Ø³ØªÙˆÙ‰ 1: ØªØ³Ø®ÙŠÙ†": mLevel===2?"Ù…Ø³ØªÙˆÙ‰ 2: Ù…ØªÙˆØ³Ø·":"Ù…Ø³ØªÙˆÙ‰ 3: ØµØ¹Ø¨";
            grid.style.gridTemplateColumns = mLevel===1?"repeat(2,1fr)":"repeat(3,1fr)";
            target=num;
            
            // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© ÙƒØ¨Ø¯ÙŠÙ„ Ø¢Ù…Ù†
            let currentEmojis = emojis.slice(0, num);
            let cards = [...currentEmojis, ...currentEmojis].sort(()=>0.5-Math.random());
            
            cards.forEach(emoji => {
                let d = document.createElement('div'); d.className='card'; d.dataset.name=emoji;
                d.innerHTML=`<div class="back">â“</div><div style="font-size:30px;">${emoji}</div>`;
                d.onclick=()=>doFlip(d); grid.appendChild(d);
            });
        }
        function doFlip(c) { if(flip.length<2 && !c.classList.contains('flipped')) { c.classList.add('flipped'); flip.push(c); if(flip.length===2) chkMatch(); }}
        function chkMatch() {
            if(flip[0].dataset.name === flip[1].dataset.name) {
                pairs++; flip=[]; if(pairs===target) setTimeout(()=>{ if(mLevel<3){mLevel++; initMemoryGame();} else nextStage('game1','game2'); },500);
            } else setTimeout(()=>{ flip[0].classList.remove('flipped'); flip[1].classList.remove('flipped'); flip=[]; },800);
        }

        // --- XO Logic ---
        let board=['','','','','','','','',''], ease=0, xoFailCount=0, active=true, xoLevel = 1; 
        function initXO() { 
            document.getElementById('xoLevelText').innerText = xoLevel===1 ? "Ø§Ù„Ù…Ø³ØªÙˆÙ‰: 1 (Ø³Ù‡Ù„)" : xoLevel===2 ? "Ø§Ù„Ù…Ø³ØªÙˆÙ‰: 2 (Ù…ØªÙˆØ³Ø·)" : "Ø§Ù„Ù…Ø³ØªÙˆÙ‰: 3 (ØµØ¹Ø¨)";
            drawXO(); 
        }
        function drawXO() { 
            const d=document.getElementById('xoBoard'); d.innerHTML='';
            board.forEach((v,i)=>{ let b=document.createElement('div'); b.className=`cell ${v=='X'?'x':v=='O'?'o':''}`; b.innerText=v; b.onclick=()=>mv(i); d.appendChild(b); });
        }
        function mv(i) { 
            if(board[i]=='' && active) { 
                board[i]='X'; drawXO(); 
                if(chk('X')) winXO(); 
                else if(!board.includes('')) failXO(true); 
                else { active=false; const st=document.getElementById('xoStatus'); st.innerText='ÙŠÙÙƒØ±...'; setTimeout(ai,600); } 
            } 
        }
        function ai() {
            let baseDiff = xoLevel===1 ? 30 : xoLevel===2 ? 60 : 95; let finalDiff = baseDiff - ease;
            let smart = Math.random()*100 < finalDiff; let idx = smart ? bestMv() : rndMv();
            if(idx==-1) idx=rndMv();
            board[idx]='O'; drawXO(); 
            if(chk('O')) failXO(false);
            else if(!board.includes('')) failXO(true); 
            else { active=true; document.getElementById('xoStatus').innerText='Ø¯ÙˆØ±Ùƒ'; }
        }
        function failXO(isDraw) { 
            const st = document.getElementById('xoStatus'); xoFailCount++;
            st.innerText = isDraw ? 'ØªØ¹Ø§Ø¯Ù„ ğŸ˜' : 'Ø®Ø³Ø±ØªÙŠ ğŸ˜œ'; st.style.color = '#ff6b81';
            if (xoFailCount % 3 === 0) { ease += 20; if(ease > 90) ease = 90; document.getElementById('easeText').innerText = `ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØµØ¹ÙˆØ¨Ù‡ ğŸ“‰`; document.getElementById('easeText').style.display = 'block'; }
            setTimeout(rstXO, 1500);
        }
        function winXO() { 
            const st = document.getElementById('xoStatus'); st.innerText = 'Ø´Ø·ÙˆØ±ØªÙŠÙŠ ğŸ˜'; st.style.color = '#48cfad'; 
            showToast("Ø´Ø·ÙˆØ±ØªÙŠ ğŸ’‹");
            setTimeout(() => { if(xoLevel < 3) { xoLevel++; xoFailCount = 0; document.getElementById('easeText').style.display='none'; ease = 0; rstXO(); initXO(); } else { nextStage('game2','game3'); } }, 1500);
        }
        function rstXO() { board.fill(''); active=true; drawXO(); document.getElementById('xoStatus').innerText='Ø¯ÙˆØ±Ùƒ'; }
        function rndMv() { let e=board.map((v,i)=>v==''?i:null).filter(v=>v!=null); return e[Math.floor(Math.random()*e.length)]; }
        function bestMv() { for(let i=0;i<9;i++) if(board[i]==''){ board[i]='O'; if(chk('O')){board[i]='';return i;} board[i]=''; } for(let i=0;i<9;i++) if(board[i]==''){ board[i]='X'; if(chk('X')){board[i]='';return i;} board[i]=''; } return rndMv(); }
        function chk(p) { return [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]].some(c=>c.every(i=>board[i]==p)); }

        // --- Color Game ---
        const clrs=['green','red','yellow','blue']; 
        let seq=[], usr=[], cLvl=1, turn=false, colorFailCount=0, isHardMode = false; 
        function initColorGame() { cLvl=1; seq=[]; colorFailCount=0; isHardMode=false; document.getElementById('skipBtn').style.display='none'; startCol(); }
        function startCol() {
            usr=[]; turn=false;
            const st = document.getElementById('colorStatus');
            let len = isHardMode ? 16 : (cLvl==1?4: cLvl==2?6:8);
            document.getElementById('colorLevelText').innerHTML = isHardMode ? `<span style="color:red">16</span> (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„)` : `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${cLvl} (${len} Ø®Ø·ÙˆØ§Øª)`;
            st.innerText = 'Ø´ÙˆÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨..';
            seq=[]; for(let i=0;i<len;i++) seq.push(clrs[Math.floor(Math.random()*4)]);
            setTimeout(()=>playSeq(0),1000);
        }
        function playSeq(i) {
            if(i>=seq.length) { turn=true; document.getElementById('colorStatus').innerText='Ø¯ÙˆØ±Ùƒ'; return; }
            let b=document.getElementById(seq[i]); b.classList.add('active');
            setTimeout(()=>{ b.classList.remove('active'); setTimeout(()=>playSeq(i+1),500); },500);
        }
        function handleColorClick(c) {
            if(!turn) return;
            let b=document.getElementById(c); b.classList.add('active'); setTimeout(()=>b.classList.remove('active'),200);
            usr.push(c);
            const st = document.getElementById('colorStatus');
            if(usr[usr.length-1] !== seq[usr.length-1]) {
                st.innerText='Ø®Ø·Ø£!'; st.style.color='red'; colorFailCount++;
                if(cLvl === 3 && !isHardMode && colorFailCount >= 3) document.getElementById('skipBtn').style.display='block';
                setTimeout(startCol, 1500); turn=false; return;
            }
            if(usr.length===seq.length) {
                st.innerText='Ø´Ø·ÙˆØ±ØªÙŠ'; st.style.color='#48cfad'; 
                if(isHardMode || cLvl === 3) { setTimeout(() => { nextStage('game3','fullMarioGame'); }, 500); }
                else { cLvl++; colorFailCount=0; setTimeout(startCol,1000); }
            }
        }
        function showQuiz() { document.getElementById('quizModal').style.display='flex'; document.getElementById('quizError').innerText = ''; document.getElementById('quizAnswer').value = ''; }
        let quizWrongAttempts = 0;
        function checkAnswer() {
            let a = document.getElementById('quizAnswer').value.trim().toLowerCase();
            if(["Ø§Ù†Ø§", "Ø£Ù†Ø§", "Ù‡Ø¨Ù‡", "Ù‡Ø¨Ø©"].includes(a)) { document.getElementById('quizModal').style.display='none'; nextStage('game3','fullMarioGame'); }
            else { quizWrongAttempts++; document.getElementById('quizError').innerText = quizWrongAttempts===1?'ØºØ±ÙŠØ¨Ù‡ Ù…Ø§ Ø¹Ø±ÙØªÙŠ': quizWrongAttempts===2?'Ø´ÙÙŠÙƒ Ø³Ù‡Ù„Ù‡':'ØºØ±ÙŠØ¨Ù‡ Ø§Ù„Ù‚Ù…Ø± Ù…Ø§ ÙŠØ¹Ø±Ù Ù†ÙØ³Ùˆ'; }
        }
        function closeQuiz() { document.getElementById('quizModal').style.display='none'; alert('Ø±Ø¬Ø¹ØªÙŠ Ø·ÙŠØ¨ ÙŠÙ„Ø§ ÙˆØ±ÙŠÙ†ÙŠ ÙƒÙŠÙ Ø¨Ø¯Ùƒ ØªØ­Ù„ÙŠ ØŸ'); isHardMode = true; document.getElementById('hardModeText').style.display = 'block'; startCol(); }

        // --- Mario Full Game ---
        function startFullMario() {
            const bgVideo = document.getElementById('bgVideo');
            const lyricsVideo = document.getElementById('lyricsVideo');
            bgVideo.pause(); lyricsVideo.pause();

            const marioContainer = document.getElementById('fullMarioGame');
            const marioFrame = document.getElementById('marioFrame');
            marioFrame.src = "https://0xlostbyte.github.io/mariohtml5/";
            marioContainer.style.display = 'block';
            showToast("Ø§Ø³ØªÙ…ØªØ¹ÙŠ Ø¨Ù…Ø§Ø±ÙŠÙˆ! ğŸ˜");
        }

        function finishMario() {
            const bgVideo = document.getElementById('bgVideo');
            const lyricsVideo = document.getElementById('lyricsVideo');
            bgVideo.play(); lyricsVideo.play();

            const marioContainer = document.getElementById('fullMarioGame');
            const marioFrame = document.getElementById('marioFrame');
            marioContainer.style.display = 'none';
            marioFrame.src = ""; 
            initMarriageVideo();
        }

        // --- Marriage Video Logic ---
        let marryPressTimer;
        const marryLayer = document.getElementById('marryVideoLayer');
        const marryVid = document.getElementById('marryVideo');
        const fingerHint = document.getElementById('fingerHint');
        const mainBtn = document.getElementById('mainFingerBtn');

        function initMarriageVideo() {
            marryLayer.style.display = 'block';
            marryVid.currentTime = 0;
            marryVid.pause(); 
        }

        function startPress(e) {
            e.preventDefault();
            fingerHint.classList.add('pressing');
            marryPressTimer = setTimeout(() => {
                runMarryVideo();
            }, 2000); 
        }

        function endPress() {
            clearTimeout(marryPressTimer);
            fingerHint.classList.remove('pressing');
        }

        mainBtn.addEventListener('mousedown', startPress);
        mainBtn.addEventListener('touchstart', startPress);
        window.addEventListener('mouseup', endPress);
        window.addEventListener('touchend', endPress);

        function runMarryVideo() {
            fingerHint.style.display = 'none';
            marryVid.style.display = 'block';
            marryVid.muted = false;
            marryVid.play();
            
            marryVid.onended = () => {
                marryLayer.style.background = 'black';
                marryVid.style.display = 'none';
                marryLayer.style.display = 'none';
                document.getElementById('game6').classList.add('active-game');
            };
        }

        // --- Magic Heart & Box Logic ---
        let heartTimer;
        const magicHeart = document.getElementById('magicHeart');
        const heartInst = document.getElementById('heartInstruction');
        let charge = 1;
        let giftClicks = 0;

        magicHeart.addEventListener('mousedown', startHeartCharge);
        magicHeart.addEventListener('touchstart', startHeartCharge);
        magicHeart.addEventListener('mouseup', stopHeartCharge);
        magicHeart.addEventListener('touchend', stopHeartCharge);

        function startHeartCharge(e) {
            e.preventDefault();
            magicHeart.classList.add('charging');
            
            heartTimer = setInterval(() => {
                charge += 0.1;
                magicHeart.style.transform = `scale(${charge})`;
                magicHeart.style.filter = `drop-shadow(0 0 ${charge * 20}px red)`;
                
                if (charge > 4) { 
                    clearInterval(heartTimer);
                    triggerThanosTransformation();
                }
            }, 100);
        }

        function stopHeartCharge() {
            clearInterval(heartTimer);
            magicHeart.classList.remove('charging');
            charge = Math.max(1, charge - 0.5); 
            magicHeart.style.transform = `scale(${charge})`;
        }

        function triggerThanosTransformation() {
            const black = document.getElementById('blackOverlay');
            const snap = document.getElementById('snapSound');
            const white = document.getElementById('whiteFlash');
            const burnVid = document.getElementById('burnBgVideo');
            const somkeVid = document.getElementById('bgVideo');
            const lyricsVid = document.getElementById('lyricsVideo');
            const container = document.getElementById('game6');

            black.style.display = 'block';
            document.getElementById('magicHeart').style.display = 'none';
            heartInst.style.display = 'none';

            setTimeout(() => {
                snap.play();
                black.style.display = 'none';
                white.style.display = 'block';
                
                somkeVid.pause(); somkeVid.style.display = 'none';
                lyricsVid.pause(); lyricsVid.style.display = 'none';
                
                document.body.classList.remove('dark-mode');
                document.body.classList.add('burn-mode');
                container.classList.remove('dark-mode');
                container.classList.add('burn-mode');
                
                burnVid.style.display = 'block';
                burnVid.muted = false; burnVid.volume = 1.0; burnVid.play(); 

                setTimeout(() => {
                    white.style.opacity = '0';
                    setTimeout(() => { white.style.display = 'none'; }, 1000);
                    burnVid.style.filter = "blur(0px) brightness(1)";

                    const gift = document.getElementById('finalGift');
                    gift.style.display = 'block';
                    document.querySelector('#game6 h2').innerText = "Ø§Ø¶ØºØ·ÙŠ 10 Ù…Ø±Ø§Øª!";
                }, 500);
            }, 1000);
        }

        function clickGift() {
            giftClicks++;
            const gift = document.getElementById('finalGift');
            gift.style.transform = `scale(${1 + giftClicks * 0.1})`;
            
            if (giftClicks >= 10) {
                gift.style.display = 'none';
                const flower = document.getElementById('finalFlower');
                flower.style.display = 'block';
                document.querySelector('#game6 h2').innerText = "ÙˆØ±Ø¯Ø© Ù„Ø£Ø­Ù„Ù‰ ÙˆØ±Ø¯Ø© ÙÙŠ Ø¯Ù†ÙŠØªÙŠ â¤ï¸";
                
                setTimeout(() => {
                    document.getElementById('game6').style.opacity = "0";
                }, 10000);

                const burnVid = document.getElementById('burnBgVideo');
                burnVid.onended = () => {
                    window.location.href = "end.html";
                };
            }
        }
    </script>
</body>
</html>